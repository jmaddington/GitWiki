{% extends "editor/base.html" %}

{% block title %}Edit: {{ file_path }} - GitWiki{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <!-- Quick Actions (No Session Required) -->
            <div class="card mb-3 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="me-3 text-muted"><i class="fas fa-bolt"></i> Quick Actions:</span>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-primary" id="btn-upload-file" title="Upload any file directly to main (up to 100MB)">
                                <i class="fas fa-file-upload"></i> Upload File
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stale Draft Warning -->
            <div id="stale-draft-warning" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Draft may be outdated</strong>
                        <p class="mb-0">This draft differs from the current version on main. You can continue editing or discard the draft to start fresh.</p>
                    </div>
                    <div class="ms-3">
                        <button type="button" class="btn btn-sm btn-danger" id="btn-discard-draft">
                            <i class="fas fa-trash"></i> Discard Draft
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> Editing: <code>{{ file_path }}</code>
                    </h5>
                    <div>
                        <span id="status-indicator" class="badge bg-secondary">
                            <span class="status-indicator status-saved"></span>
                            <span id="status-text">Loading...</span>
                        </span>
                        <span id="session-info" class="badge bg-info ms-2">
                            Session: <span id="session-id">-</span>
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Editor Toolbar (Session Actions) -->
                    <div class="btn-toolbar mb-3" role="toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-primary" id="btn-commit" title="Commit changes to draft branch">
                                <i class="fas fa-save"></i> Commit Draft
                            </button>
                            <button type="button" class="btn btn-success" id="btn-publish" title="Publish to main branch">
                                <i class="fas fa-upload"></i> Publish
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-secondary" id="btn-upload-image" title="Upload image to draft">
                                <i class="fas fa-image"></i> Upload Image
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary" id="btn-preview" title="Toggle preview">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <a href="/editor/sessions/" class="btn btn-outline-secondary" title="View all sessions">
                                <i class="fas fa-list"></i> My Drafts
                            </a>
                            <button type="button" class="btn btn-outline-danger" id="btn-discard-draft-toolbar" title="Discard this draft and reload from main">
                                <i class="fas fa-trash"></i> Discard Draft
                            </button>
                            <a href="/" class="btn btn-outline-danger" title="Cancel editing">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>

                    <!-- Markdown Editor -->
                    <div id="markdown-editor"></div>

                    <!-- Hidden file input for image upload -->
                    <input type="file" id="image-file-input" accept="image/png,image/jpeg,image/jpg,image/webp" style="display: none;">

                    <!-- Hidden file input for arbitrary file upload -->
                    <input type="file" id="file-input" style="display: none;">

                    <!-- Validation Errors -->
                    <div id="validation-errors" class="mt-3" style="display: none;">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>Validation Warnings:</strong>
                            <ul id="validation-list" class="mb-0 mt-2"></ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <div class="row">
                        <div class="col-md-6">
                            <small>
                                <i class="fas fa-code-branch"></i> Branch: <code id="branch-name">-</code>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small id="last-save-time">Auto-save: Not yet saved</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Commit Modal -->
<div class="modal fade" id="commitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Commit Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="commit-message" class="form-label">Commit Message *</label>
                    <input type="text" class="form-control" id="commit-message"
                           placeholder="Describe your changes..." required>
                    <div class="form-text">Briefly describe what you changed</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-confirm-commit">
                    <i class="fas fa-save"></i> Commit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Publish Confirmation Modal -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Publish to Main Branch</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to publish your changes to the main branch?</p>
                <p class="text-muted"><small>This will merge your draft branch and make changes visible to everyone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="btn-confirm-publish">
                    <i class="fas fa-upload"></i> Publish Now
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // AIDEV-NOTE: editor-client; Toast UI editor with auto-save and clipboard paste

    // Configuration
    const AUTO_SAVE_INTERVAL = 60000; // 60 seconds
    const LOCALSTORAGE_KEY = 'gitwiki_draft_{{ file_path }}';
    const API_BASE = '/editor/api';

    // CSRF Token Support
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Configure axios to send CSRF token with every request
    axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');

    // Helper function to extract error messages from API responses
    function extractErrorMessage(error, defaultMessage = 'An error occurred') {
        if (error.response?.data) {
            const data = error.response.data;

            if (typeof data === 'string') {
                return data;
            } else if (data.error?.message) {
                // Standardized error format: {success: false, error: {message: '...', validation_errors: {...}}}
                let message = data.error.message;

                // Add validation errors if present
                if (data.error.validation_errors) {
                    const validationErrors = data.error.validation_errors;
                    const errorList = Object.entries(validationErrors)
                        .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                        .join('\n');
                    message += '\n\nValidation errors:\n' + errorList;
                }
                return message;
            } else if (data.message) {
                return data.message;
            } else if (data.detail) {
                return data.detail;
            } else {
                return JSON.stringify(data, null, 2);
            }
        } else if (error.message) {
            return error.message;
        }
        return defaultMessage;
    }

    // State
    let editorState = {
        sessionId: null,
        branchName: null,
        filePath: '{{ file_path }}',
        lastSaved: null,
        modified: false,
        autoSaveTimer: null,
        editor: null
    };

    // Initialize Toast UI Editor
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing editor...');
        try {
            initializeEditor();
            startEditSession();
        } catch (error) {
            console.error('Failed to initialize:', error);
            updateStatus('error', 'Failed to initialize editor: ' + error.message);
        }
    });

    function initializeEditor() {
        console.log('Creating Toast UI Editor instance...');
        console.log('Checking for Toast UI global object...');
        console.log('typeof toastui:', typeof toastui);
        console.log('typeof window.toastui:', typeof window.toastui);
        console.log('All window properties containing "toast":', Object.keys(window).filter(k => k.toLowerCase().includes('toast')));

        // Check if Toast UI is loaded
        if (typeof toastui === 'undefined') {
            throw new Error('Toast UI Editor library not loaded. Check CDN connection.');
        }

        editorState.editor = new toastui.Editor({
            el: document.querySelector('#markdown-editor'),
            height: '600px',
            initialEditType: 'markdown',
            previewStyle: 'vertical',
            placeholder: 'Start writing your markdown content here...',
            usageStatistics: false,
            autofocus: false,
            hideModeSwitch: false,

            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr', 'quote'],
                ['ul', 'ol', 'task'],
                ['table', 'image', 'link'],
                ['code', 'codeblock']
            ],

            // Custom HTML renderer to convert relative image paths to absolute URLs
            customHTMLRenderer: {
                image(node) {
                    const { destination, altText } = node;
                    let src = destination;

                    // Convert relative paths to absolute URLs
                    if (src && !src.startsWith('http://') && !src.startsWith('https://') && !src.startsWith('//') && !src.startsWith('/')) {
                        // Get the directory of the current file being edited
                        const filePath = '{{ file_path }}';
                        const lastSlash = filePath.lastIndexOf('/');
                        const fileDir = lastSlash > 0 ? filePath.substring(0, lastSlash) : '';

                        // Resolve relative path
                        let resolvedPath = src;
                        if (fileDir) {
                            resolvedPath = fileDir + '/' + src;
                        }

                        src = '/wiki/file/' + resolvedPath;
                    }

                    return {
                        type: 'openTag',
                        tagName: 'img',
                        attributes: { src, alt: altText || '' }
                    };
                }
            },

            events: {
                change: () => {
                    editorState.modified = true;
                    updateStatus('modified', 'Modified (not saved)');
                },
                load: () => {
                    console.log('Toast UI Editor loaded successfully');
                }
            },

            hooks: {
                addImageBlobHook: async (blob, callback) => {
                    if (!editorState.sessionId) {
                        showToast('Please start an edit session first', 'warning', 3000);
                        return false;
                    }

                    updateStatus('loading', 'Uploading image...');

                    const formData = new FormData();
                    formData.append('session_id', editorState.sessionId);
                    formData.append('image', blob);
                    formData.append('alt_text', blob.name || 'Pasted image');

                    try {
                        const response = await axios.post(`${API_BASE}/upload-image/`, formData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        });

                        const data = response.data.data;

                        // Toast UI expects URL and alt text, handles markdown insertion automatically
                        // Convert relative path to absolute URL for proper display in preview
                        const absoluteUrl = '/wiki/file/' + data.path;
                        callback(absoluteUrl, data.alt_text || blob.name || '');

                        updateStatus('saved', 'Image uploaded');
                        editorState.modified = true;

                        showToast(`Image uploaded! Size: ${(data.file_size_bytes / 1024).toFixed(1)} KB`, 'success', 3000);

                    } catch (error) {
                        console.error('Image upload failed:', error);
                        updateStatus('error', 'Upload failed');
                        showToast('Error: ' + extractErrorMessage(error, 'Failed to upload image'), 'error', 5000);
                    }

                    return false; // Prevent default base64 encoding
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to commit
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showCommitModal();
            }
        });
    }

    async function startEditSession() {
        updateStatus('loading', 'Starting edit session...');

        try {
            const response = await axios.post(`${API_BASE}/start/`, {
                file_path: editorState.filePath
            });

            const data = response.data.data;  // API returns {success: true, data: {...}}
            editorState.sessionId = data.session_id;
            editorState.branchName = data.branch_name;

            // Set editor content
            editorState.editor.setMarkdown(data.content);

            // Update UI
            document.getElementById('session-id').textContent = data.session_id;
            document.getElementById('branch-name').textContent = data.branch_name;

            updateStatus('saved', data.resumed ? 'Session resumed' : 'Ready to edit');

            // Show stale draft warning if needed
            if (data.is_stale) {
                document.getElementById('stale-draft-warning').style.display = 'block';
            }

            // Start auto-save
            startAutoSave();

            // Check localStorage for unsaved changes (skip if draft is stale to avoid confusion)
            if (!data.is_stale) {
                checkLocalStorage();
            }

        } catch (error) {
            console.error('Failed to start edit session:', error);
            updateStatus('error', 'Failed to start session');
            showToast('Error: ' + extractErrorMessage(error, 'Failed to start edit session'), 'error', 5000);
        }
    }

    function startAutoSave() {
        if (editorState.autoSaveTimer) {
            clearInterval(editorState.autoSaveTimer);
        }

        editorState.autoSaveTimer = setInterval(async () => {
            if (editorState.modified) {
                await saveDraft();
            }
        }, AUTO_SAVE_INTERVAL);
    }

    async function saveDraft() {
        if (!editorState.sessionId) return;

        const content = editorState.editor.getMarkdown();

        // Save to localStorage
        localStorage.setItem(LOCALSTORAGE_KEY, content);

        // Validate on server
        try {
            const response = await axios.post(`${API_BASE}/save/`, {
                session_id: editorState.sessionId,
                content: content
            });

            const data = response.data.data;  // API returns {success: true, data: {...}}
            editorState.lastSaved = new Date(data.saved_at);
            editorState.modified = false;

            updateStatus('saved', 'Auto-saved');
            document.getElementById('last-save-time').textContent =
                `Auto-saved at ${editorState.lastSaved.toLocaleTimeString()}`;

            // Show validation warnings if any
            if (data.validation_warnings && data.validation_warnings.length > 0) {
                showValidationWarnings(data.validation_warnings);
            } else {
                hideValidationWarnings();
            }

        } catch (error) {
            console.error('Auto-save failed:', error);
            updateStatus('error', 'Auto-save failed');
        }
    }

    function showCommitModal() {
        const modal = new bootstrap.Modal(document.getElementById('commitModal'));
        modal.show();

        // Focus on commit message input
        setTimeout(() => {
            document.getElementById('commit-message').focus();
        }, 500);
    }

    document.getElementById('btn-commit').addEventListener('click', showCommitModal);

    document.getElementById('btn-confirm-commit').addEventListener('click', async function() {
        const commitMessage = document.getElementById('commit-message').value.trim();

        if (!commitMessage) {
            showToast('Please enter a commit message', 'warning', 3000);
            return;
        }

        updateStatus('loading', 'Committing...');

        try {
            const content = editorState.editor.getMarkdown();
            const response = await axios.post(`${API_BASE}/commit/`, {
                session_id: editorState.sessionId,
                content: content,
                commit_message: commitMessage
            });

            const data = response.data.data;  // API returns {success: true, data: {...}}

            // Clear localStorage
            localStorage.removeItem(LOCALSTORAGE_KEY);

            updateStatus('saved', 'Committed successfully');
            editorState.modified = false;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('commitModal')).hide();
            document.getElementById('commit-message').value = '';

            showToast('Changes committed successfully! Commit: ' + data.commit_hash.substring(0, 8), 'success', 3000);

        } catch (error) {
            console.error('Commit failed:', error);
            updateStatus('error', 'Commit failed');
            showToast('Error: ' + extractErrorMessage(error, 'Failed to commit changes'), 'error', 5000);
        }
    });

    document.getElementById('btn-publish').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('publishModal'));
        modal.show();
    });

    // Discard draft button handler (warning banner)
    document.getElementById('btn-discard-draft').addEventListener('click', discardDraft);

    // Discard draft button handler (toolbar)
    document.getElementById('btn-discard-draft-toolbar').addEventListener('click', discardDraft);

    async function discardDraft() {
        if (!confirm('Are you sure you want to discard this draft? This will delete the draft session and reload the current version from main.')) {
            return;
        }

        updateStatus('loading', 'Discarding draft...');

        try {
            const response = await axios.post(`${API_BASE}/discard/`, {
                session_id: editorState.sessionId
            });

            // Clear localStorage
            localStorage.removeItem(LOCALSTORAGE_KEY);

            showToast('Draft discarded. Reloading page...', 'success', 1500);

            // Reload the page to start fresh
            setTimeout(() => {
                window.location.reload();
            }, 1500);

        } catch (error) {
            console.error('Failed to discard draft:', error);
            updateStatus('error', 'Failed to discard draft');
            showToast('Error: ' + extractErrorMessage(error, 'Failed to discard draft'), 'error', 5000);
        }
    }

    document.getElementById('btn-confirm-publish').addEventListener('click', async function() {
        updateStatus('loading', 'Publishing...');

        try {
            const content = editorState.editor.getMarkdown();
            const response = await axios.post(`${API_BASE}/publish/`, {
                session_id: editorState.sessionId,
                content: content,
                commit_message: 'Publish changes',
                auto_push: true
            });

            const responseData = response.data;  // API returns {success: true, data: {...}} or {success: false, conflict: true}

            if (responseData.success) {
                const data = responseData.data;

                // Clear localStorage
                localStorage.removeItem(LOCALSTORAGE_KEY);

                showToast('Published successfully! Redirecting...', 'success', 2000, data.url);

            } else if (responseData.conflict) {
                // Handle conflict
                bootstrap.Modal.getInstance(document.getElementById('publishModal')).hide();
                showToast('Merge conflict detected! Your changes conflict with main branch. Please resolve conflicts first.', 'warning', 5000);
                updateStatus('error', 'Conflict detected');
            }

        } catch (error) {
            console.error('Publish failed:', error);
            updateStatus('error', 'Publish failed');

            if (error.response?.status === 409) {
                showToast('Merge conflict detected! Please resolve conflicts before publishing.', 'warning', 5000);
            } else {
                showToast('Error: ' + extractErrorMessage(error, 'Failed to publish'), 'error', 5000);
            }
        }
    });

    // Image upload button
    document.getElementById('btn-upload-image').addEventListener('click', function() {
        document.getElementById('image-file-input').click();
    });

    document.getElementById('image-file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        await uploadImage(file);

        // Clear the input
        e.target.value = '';
    });

    // Handle arbitrary file upload
    document.getElementById('btn-upload-file').addEventListener('click', function() {
        document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        await uploadFile(file);

        // Clear the input
        e.target.value = '';
    });

    async function uploadImage(file, altText = '') {
        if (!editorState.sessionId) {
            showToast('Please start an edit session first', 'warning', 3000);
            return;
        }

        updateStatus('loading', 'Uploading image...');

        const formData = new FormData();
        formData.append('session_id', editorState.sessionId);
        formData.append('image', file);
        formData.append('alt_text', altText || file.name.split('.')[0]);

        try {
            const response = await axios.post(`${API_BASE}/upload-image/`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            const data = response.data.data;  // API returns {success: true, data: {...}}

            // Convert relative path to absolute URL for proper display in preview
            const absoluteUrl = '/wiki/file/' + data.path;
            const absoluteMarkdown = `![${altText || file.name.split('.')[0]}](${absoluteUrl})`;

            // Insert markdown at cursor
            editorState.editor.insertText(absoluteMarkdown + '\n');

            updateStatus('saved', 'Image uploaded');
            editorState.modified = true;

            showToast('Image uploaded successfully! Size: ' + (data.file_size_bytes / 1024).toFixed(1) + ' KB', 'success', 3000);

        } catch (error) {
            console.error('Image upload failed:', error);
            updateStatus('error', 'Upload failed');
            showToast('Error: ' + extractErrorMessage(error, 'Failed to upload image'), 'error', 5000);
        }
    }

    async function uploadFile(file, description = '') {
        // Check file size (100MB limit)
        const maxSize = 100 * 1024 * 1024; // 100MB in bytes
        if (file.size > maxSize) {
            showToast('File too large. Maximum size is 100MB', 'error', 5000);
            return;
        }

        updateStatus('loading', 'Uploading file...');

        // Extract directory from current file path (e.g., "docs/guide.md" -> "docs")
        const filePath = editorState.filePath;
        const lastSlashIndex = filePath.lastIndexOf('/');
        const targetPath = lastSlashIndex > 0 ? filePath.substring(0, lastSlashIndex) : '';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('target_path', targetPath);
        formData.append('description', description || '');

        try {
            const response = await axios.post(`${API_BASE}/quick-upload-file/`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            const data = response.data.data;  // API returns {success: true, data: {...}}

            // Insert markdown at cursor if editor is available
            if (editorState.editor) {
                editorState.editor.insertText(data.markdown + '\n');
                editorState.modified = true;
            }

            updateStatus('saved', 'File uploaded');

            const sizeStr = data.file_size_bytes > 1024 * 1024
                ? (data.file_size_bytes / (1024 * 1024)).toFixed(1) + ' MB'
                : (data.file_size_bytes / 1024).toFixed(1) + ' KB';

            showToast('File uploaded successfully! Size: ' + sizeStr + '\nPath: ' + data.path, 'success', 5000);

        } catch (error) {
            console.error('File upload failed:', error);
            updateStatus('error', 'Upload failed');
            showToast('Error: ' + extractErrorMessage(error, 'Failed to upload file'), 'error', 5000);
        }
    }

    function checkLocalStorage() {
        const saved = localStorage.getItem(LOCALSTORAGE_KEY);
        if (saved && saved !== editorState.editor.getMarkdown()) {
            if (confirm('Found unsaved changes from a previous session. Restore them?')) {
                editorState.editor.setMarkdown(saved);
                editorState.modified = true;
                updateStatus('modified', 'Restored from localStorage');
            } else {
                localStorage.removeItem(LOCALSTORAGE_KEY);
            }
        }
    }

    function updateStatus(type, text) {
        const indicator = document.querySelector('#status-indicator .status-indicator');
        const statusText = document.getElementById('status-text');
        const badge = document.getElementById('status-indicator');

        // Remove all status classes
        indicator.classList.remove('status-saved', 'status-modified', 'status-error');
        badge.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');

        // Add appropriate class
        switch (type) {
            case 'saved':
                indicator.classList.add('status-saved');
                badge.classList.add('bg-success');
                break;
            case 'modified':
                indicator.classList.add('status-modified');
                badge.classList.add('bg-warning');
                break;
            case 'error':
                indicator.classList.add('status-error');
                badge.classList.add('bg-danger');
                break;
            case 'loading':
                badge.classList.add('bg-secondary');
                break;
        }

        statusText.textContent = text;
    }

    function showValidationWarnings(warnings) {
        const errorDiv = document.getElementById('validation-errors');
        const errorList = document.getElementById('validation-list');

        errorList.innerHTML = '';
        warnings.forEach(warning => {
            const li = document.createElement('li');
            li.textContent = warning.message;
            errorList.appendChild(li);
        });

        errorDiv.style.display = 'block';
    }

    function hideValidationWarnings() {
        document.getElementById('validation-errors').style.display = 'none';
    }

    // Toast notification system
    function showToast(message, type = 'success', duration = 3000, redirectUrl = null) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        // Icon based on type
        const icons = {
            'success': '<i class="fas fa-check-circle"></i>',
            'error': '<i class="fas fa-exclamation-circle"></i>',
            'warning': '<i class="fas fa-exclamation-triangle"></i>',
            'info': '<i class="fas fa-info-circle"></i>'
        };

        toast.innerHTML = `
            ${icons[type] || icons['info']}
            <span class="toast-message">${message}</span>
        `;

        toastContainer.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);

        // Auto-hide and redirect
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            }, 300);
        }, duration);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function(e) {
        if (editorState.modified) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
</script>

<style>
#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}

.toast {
    background: white;
    border-radius: 8px;
    padding: 16px 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 500px;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    pointer-events: auto;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast i {
    font-size: 24px;
    flex-shrink: 0;
}

.toast-message {
    flex: 1;
    font-size: 14px;
    line-height: 1.5;
}

.toast-success {
    border-left: 4px solid #28a745;
}

.toast-success i {
    color: #28a745;
}

.toast-error {
    border-left: 4px solid #dc3545;
}

.toast-error i {
    color: #dc3545;
}

.toast-warning {
    border-left: 4px solid #ffc107;
}

.toast-warning i {
    color: #ffc107;
}

.toast-info {
    border-left: 4px solid #17a2b8;
}

.toast-info i {
    color: #17a2b8;
}
</style>

<!-- Toast Container -->
<div id="toast-container"></div>

{% endblock %}
