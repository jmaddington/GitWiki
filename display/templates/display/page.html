{% extends "display/base.html" %}

{% block title %}{% with breadcrumbs|last as last_crumb %}{% if last_crumb %}{{ last_crumb.name }}{% else %}Home{% endif %}{% endwith %} - GitWiki{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
    <!-- Main Content Area -->
    <div class="col-lg-9">
        <!-- Breadcrumbs -->
        {% if breadcrumbs %}
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% for crumb in breadcrumbs %}
                <li class="breadcrumb-item {% if forloop.last %}active{% endif %}">
                    {% if forloop.last %}
                        {{ crumb.name }}
                    {% else %}
                        <a href="{{ crumb.url }}">{{ crumb.name }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ol>
        </nav>
        {% endif %}

        <!-- Page Actions -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                {% if branch and branch != 'main' %}
                <span class="badge bg-warning">
                    <i class="fas fa-code-branch"></i> {{ branch }}
                </span>
                {% endif %}
            </div>
            <div class="btn-group" role="group">
                {% if edit_url and not is_directory %}
                <a href="{{ edit_url }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit"></i> Edit Page
                </a>
                {% endif %}
                {% if file_path and not is_directory %}
                <a href="/wiki/history/{{ file_path }}/" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-history"></i> History
                </a>
                <button type="button" class="btn btn-sm btn-outline-danger" id="btn-delete-page"
                        data-file-path="{{ file_path }}.md">
                    <i class="fas fa-trash"></i> Delete
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Page Content -->
        <div class="wiki-content">
            {% if is_directory %}
                {{ content|safe }}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0"><i class="fas fa-folder-open"></i> Contents</h2>
                    <div class="btn-group" role="group">
                        <a href="/wiki/new/?path={{ file_path }}" class="btn btn-sm btn-success">
                            <i class="fas fa-file-plus"></i> New Page
                        </a>
                        <a href="/wiki/new-folder/?path={{ file_path }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-folder-plus"></i> New Folder
                        </a>
                    </div>
                </div>
                {% if directory_listing %}
                <table class="table table-hover directory-listing-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="text-end" style="width: 120px;">Size</th>
                            <th class="text-end" style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in directory_listing %}
                        <tr>
                            <td>
                                <a href="{{ item.url }}">
                                    {% if item.type == 'directory' %}
                                        <i class="fas fa-folder text-warning"></i>
                                    {% elif item.type == 'markdown' %}
                                        <i class="fas fa-file-alt text-primary"></i>
                                    {% elif item.type == 'viewable_image' %}
                                        <i class="fas fa-image text-success"></i>
                                    {% elif item.type == 'viewable_video' %}
                                        <i class="fas fa-film text-info"></i>
                                    {% elif item.type == 'viewable_audio' %}
                                        <i class="fas fa-music text-info"></i>
                                    {% elif item.type == 'document' %}
                                        <i class="fas fa-file text-secondary"></i>
                                    {% elif item.type == 'code' %}
                                        <i class="fas fa-code text-dark"></i>
                                    {% elif item.type == 'archive' %}
                                        <i class="fas fa-archive text-warning"></i>
                                    {% else %}
                                        <i class="fas fa-file text-muted"></i>
                                    {% endif %}
                                    {{ item.name }}
                                </a>
                            </td>
                            <td class="text-end text-muted">
                                {% if item.size %}
                                    {{ item.size }}
                                {% else %}
                                    <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if item.type != 'directory' %}
                                <button class="btn btn-sm btn-outline-danger delete-file-btn"
                                        data-file-path="{{ item.path }}"
                                        data-file-name="{{ item.name }}"
                                        title="Delete file">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">This directory is empty.</p>
                {% endif %}
            {% else %}
                {{ content|safe }}
            {% endif %}
        </div>

        <!-- Page Metadata -->
        {% if metadata and metadata.last_commit %}
        <div class="page-metadata">
            <div class="row">
                <div class="col-md-6">
                    <strong><i class="fas fa-user"></i> Last edited by:</strong>
                    {{ metadata.last_commit.author }}
                </div>
                <div class="col-md-6 text-end">
                    <strong><i class="fas fa-clock"></i> Last modified:</strong>
                    {{ metadata.last_commit.date|slice:":10" }}
                </div>
            </div>
            {% if metadata.history_summary.total_commits %}
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong><i class="fas fa-code-commit"></i> Total edits:</strong>
                    {{ metadata.history_summary.total_commits }}
                </div>
                <div class="col-md-6 text-end">
                    <strong><i class="fas fa-users"></i> Contributors:</strong>
                    {{ metadata.history_summary.contributors|length }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-3">
        <div class="wiki-sidebar">
            <!-- Quick Actions -->
            <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-sm btn-primary" id="btn-quick-upload">
                    <i class="fas fa-file-upload"></i> Upload File
                </button>
                {% if edit_url and not is_directory %}
                <a href="{{ edit_url }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-edit"></i> Edit
                </a>
                {% endif %}
                <a href="/wiki/new/{% if parent_path %}?path={{ parent_path }}{% endif %}" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-file-plus"></i> Create New Page
                </a>
                <a href="/wiki/new-folder/{% if parent_path %}?path={{ parent_path }}{% endif %}" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-folder-plus"></i> Create New Folder
                </a>
                <a href="/wiki/search/" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-search"></i> Search
                </a>
                <a href="/" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
            <hr>

            <!-- Hidden file input for quick upload -->
            <input type="file" id="quick-file-input" style="display: none;">

            <!-- Table of Contents -->
            {% if toc %}
            <h5><i class="fas fa-list"></i> Contents</h5>
            <div class="toc">
                {{ toc|safe }}
            </div>
            <hr>
            {% endif %}

            <!-- Directory Listing -->
            {% if directory_listing and not is_directory %}
            <h5><i class="fas fa-folder"></i> In this section</h5>
            <ul class="directory-listing">
                {% for item in directory_listing %}
                <li>
                    <a href="{{ item.url }}">
                        {% if item.type == 'directory' %}
                            <i class="fas fa-folder text-warning"></i>
                        {% elif item.type == 'markdown' %}
                            <i class="fas fa-file-alt text-primary"></i>
                        {% elif item.type == 'viewable_image' %}
                            <i class="fas fa-image text-success"></i>
                        {% elif item.type == 'viewable_video' %}
                            <i class="fas fa-film text-info"></i>
                        {% elif item.type == 'viewable_audio' %}
                            <i class="fas fa-music text-info"></i>
                        {% elif item.type == 'document' %}
                            <i class="fas fa-file text-secondary"></i>
                        {% elif item.type == 'code' %}
                            <i class="fas fa-code text-dark"></i>
                        {% elif item.type == 'archive' %}
                            <i class="fas fa-archive text-warning"></i>
                        {% else %}
                            <i class="fas fa-file text-muted"></i>
                        {% endif %}
                        {{ item.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize syntax highlighting
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
    });

    // Smooth scroll for TOC links
    document.querySelectorAll('.toc a').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href.startsWith('#')) {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });

    // Quick file upload
    const quickUploadBtn = document.getElementById('btn-quick-upload');
    const quickFileInput = document.getElementById('quick-file-input');

    if (quickUploadBtn && quickFileInput) {
        quickUploadBtn.addEventListener('click', function() {
            quickFileInput.click();
        });

        quickFileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (100MB limit)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File too large. Maximum size is 100MB');
                return;
            }

            // Show loading state
            quickUploadBtn.disabled = true;
            quickUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            const formData = new FormData();
            formData.append('file', file);
            // Upload to the current directory or parent directory
            formData.append('target_path', '{{ parent_path|default:"" }}');
            formData.append('description', '');

            try {
                const response = await fetch('/editor/api/quick-upload-file/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    const sizeStr = data.file_size_bytes > 1024 * 1024
                        ? (data.file_size_bytes / (1024 * 1024)).toFixed(1) + ' MB'
                        : (data.file_size_bytes / 1024).toFixed(1) + ' KB';

                    alert('File uploaded successfully!\n\nPath: ' + data.path + '\nSize: ' + sizeStr + '\n\nMarkdown link:\n' + data.markdown);
                    // Reload page to show new file
                    location.reload();
                } else {
                    alert('Upload failed: ' + (result.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                // Reset button
                quickUploadBtn.disabled = false;
                quickUploadBtn.innerHTML = '<i class="fas fa-file-upload"></i> Upload File';
                quickFileInput.value = '';
            }
        });
    }

    // Delete file buttons in directory listing
    const deleteButtons = document.querySelectorAll('.delete-file-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();

            const filePath = this.getAttribute('data-file-path');
            const fileName = this.getAttribute('data-file-name');

            // Confirm deletion - escape filename to prevent XSS
            const escapedFileName = fileName.replace(/"/g, '\\"').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            if (!confirm(`Are you sure you want to delete "${escapedFileName}"? This will commit the deletion to the repository.`)) {
                return;
            }

            // Show loading state
            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/editor/api/delete-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        file_path: filePath,
                        commit_message: `Delete ${fileName}`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('File deleted successfully!');
                    // Reload page to update listing
                    location.reload();
                } else {
                    alert('Failed to delete file: ' + (result.error?.message || 'Unknown error'));
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete file: ' + error.message);
                this.disabled = false;
                this.innerHTML = originalHTML;
            }
        });
    });

    // Delete page button (for markdown pages)
    const deletePageBtn = document.getElementById('btn-delete-page');

    if (deletePageBtn) {
        deletePageBtn.addEventListener('click', async function() {
            const filePath = this.getAttribute('data-file-path');
            // Extract filename from path
            const pathParts = filePath.split('/');
            const fileName = pathParts[pathParts.length - 1].replace('.md', '');

            // Confirm deletion - escape filename to prevent XSS
            const escapedFileName = fileName.replace(/"/g, '\\"').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            if (!confirm(`Are you sure you want to delete this page "${escapedFileName}"? This will commit the deletion to the repository.`)) {
                return;
            }

            // Show loading state
            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/editor/api/delete-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        file_path: filePath,
                        commit_message: `Delete ${fileName}`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Page deleted successfully!');
                    // Redirect to parent folder or home
                    const pathParts = filePath.split('/');
                    if (pathParts.length > 1) {
                        // Remove filename to get parent path
                        pathParts.pop();
                        window.location.href = '/wiki/' + pathParts.join('/') + '/';
                    } else {
                        window.location.href = '/';
                    }
                } else {
                    alert('Failed to delete page: ' + (result.error?.message || 'Unknown error'));
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete page: ' + error.message);
                this.disabled = false;
                this.innerHTML = originalHTML;
            }
        });
    }
</script>
{% endblock %}
